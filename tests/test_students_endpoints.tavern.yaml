---
test_name: Endpoints _ 1. Add new coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Delete test coffee (if it exists)

    request:
      url: http://{host:s}:{port:d}/coffees
      follow_redirects: true
      method: DELETE
      timeout: 1.0

  - name: Add new coffee

    request:
      url: http://{host:s}:{port:d}/coffees
      follow_redirects: true
      method: POST
      json:
        name: "Test coffee"
        farm: "Test farm"
        region: "Test region"
        fermentation: "Test fermentation"
        price: 99.00
    response:
      status_code: [200, 201]
      save:
        json:
          coffee_id: id

---
test_name: Endpoints _ 2. Fetch new coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Fetch new coffee

    request:
      url: http://{host:s}:{port:d}/coffees/{coffee_id:d}
      follow_redirects: true
      method: GET
      timeout: 1.0

    response:
      status_code: 200
      json:
        name: "Test coffee"
        farm: "Test farm"
        region: "Test region"
        fermentation: "Test fermentation"
        price: 99.00

---
test_name: Endpoints _ 3. Check total number of coffees

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Check total number of coffees

    request:
      url: http://{host:s}:{port:d}/coffees
      follow_redirects: true
      method: GET
      timeout: 1.0

    response:
      status_code: 200
      verify_response_with:
        function: testing_utils:at_least_one_coffee

---
test_name: Endpoints _ 4. Update coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Update coffee

    request:
      url: http://{host:s}:{port:d}/coffees/{coffee_id:d}
      follow_redirects: true
      method: PUT
      json:
        name: "Updated test coffee"
        farm: "Updated test farm"
        region: "Updated test region"
        fermentation: "Updated test fermentation"
        price: 100.00
      timeout: 1.0

    response:
      status_code: [200, 201]
      json:
        status: 0
        message: "Coffee updated"

---
test_name: Endpoints _ 5. Fetch updated coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Retrieve the updated coffee

    request:
      url: http://{host:s}:{port:d}/coffees/{coffee_id:d}
      follow_redirects: true
      method: GET
      timeout: 1.0

    response:
      status_code: 200
      json:
        name: "Updated test coffee"
        farm: "Updated test farm"
        region: "Updated test region"
        fermentation: "Updated test fermentation"
        price: 100.00

---
test_name: Endpoints _ 6. Modify coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Modify coffee

    request:
      url: http://{host:s}:{port:d}/coffees/{coffee_id:d}
      follow_redirects: true
      method: PATCH
      json:
        farm: "Modified test farm"
      timeout: 1.0

    response:
      status_code: [200, 201]
      json:
        status: 0
        message: "Coffee modified"

---
test_name: Endpoints _ 7. Fetch modified coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Retrieve the modified coffee

    request:
      url: http://{host:s}:{port:d}/coffees/{coffee_id:d}
      follow_redirects: true
      method: GET
      timeout: 1.0

    response:
      status_code: 200
      json:
        name: "Updated test coffee"
        farm: "Modified test farm"
        region: "Updated test region"
        fermentation: "Updated test fermentation"
        price: 100.00

---
test_name: Endpoints _ 8. Delete coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Delete the coffee

    request:
      url: http://{host:s}:{port:d}/coffees/{coffee_id:d}
      follow_redirects: true
      method: DELETE
      timeout: 1.0

    response:
      status_code: [200, 201]
      json:
        status: 0
        message: "Coffee deleted"

---
test_name: Endpoints _ 9. Fetch deleted coffee

includes:
  - !include includes.yaml

strict:
  - json:off

stages:
  - name: Retrieve the deleted coffee

    request:
      url: http://{host:s}:{port:d}/coffees/{coffee_id:d}
      follow_redirects: true
      method: GET
      timeout: 1.0

    response:
      status_code: [200, 404]
      verify_response_with:
        function: testing_utils:coffee_deleted
        extra_kwargs:
          id: "{coffee_id:d}"
